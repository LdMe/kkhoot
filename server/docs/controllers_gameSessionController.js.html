<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controllers/gameSessionController.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: controllers/gameSessionController.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { customAlphabet } from "nanoid";
import gameSessionModel from "../models/gameSession.js";
import playerModel from "../models/player.js";
import triviaModel from "../models/trivia.js";


/**
 * @module gameSessionController
 */
/**
 * Obtiene una sesi n de juego por su identificador.
 * La sesi n de juego se devuelve en formato JSON con la siguiente informaci n:
 * - Identificador de la sesi n de juego
 * - Identificador del trivia al que se est  jugando
 * - C digo de la sesi n de juego
 * - Estado de la sesi n de juego (pending, started o finished)
 * - N mero de pregunta actual
 * - Fecha de creaci n de la sesi n de juego
 * - Fecha de  ltima actualizaci n de la sesi n de juego
 * - Lista de jugadores que est n en la sesi n de juego. Cada jugador se devuelve con la siguiente informaci n:
 *   - Identificador del jugador
 *   - Nombre del jugador
 * @param {string} id - Identificador de la sesi n de juego que se quiere obtener.
 * @returns {Promise&lt;Response>} - Promesa que se resuelve con la respuesta JSON que contiene la sesi n de juego.
 */
const getGameSession = async (req, res) => {
    const id = req.params.id;
    const gameSession = await gameSessionModel.findById(id).populate("players", "name").populate("triviaId");
    res.json(gameSession);
}
const getRandomCode = customAlphabet("ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789", 6);
/**
 * Crea una nueva sesi n de juego para el trivia especificado.
 * Primero borra las sesiones anteriores para el mismo trivia (asi evitamos duplicados).
 * Luego crea una nueva sesi n de juego y la guarda en la base de datos.
 * Por  ltimo, devuelve la sesi n de juego en formato JSON.
 * @private
 * @param {string} id - Identificador del trivia para el que se quiere crear una sesi n de juego.
 * @returns {Promise&lt;Response>} - Promesa que se resuelve con la respuesta JSON que contiene la sesi n de juego.
 * @example 
 * // Ejemplo de uso
 * const response = await createGameSession(req, res);
 * res.json(response);
 * 
 */
const createGameSession = async (req, res) => {
    const triviaId = req.params.id;
    // primero borramos las sesiones anteriores para el mismo trivia (asi evitamos duplicados)
    await gameSessionModel.deleteMany({ triviaId });
    const gameSession = new gameSessionModel({ triviaId, code: getRandomCode() });
    await gameSession.save();
    res.json(gameSession);
}

const joinPlayer = async (req, res) => {
    const username = req.body.username;
    const sessionCode = req.params.id;
    const gameSession = await gameSessionModel.findOne({ code: sessionCode }).populate("players");
    console.log("gameSession", sessionCode, gameSession);
    if (gameSession.players.some(player => player.name === username)) {
        return res.status(400).json({ error: "username already exists" });
    }
    const newPlayer = new playerModel({ name: username, gameSessionId: gameSession._id })
    await newPlayer.save();
    gameSession.players.push(newPlayer);
    await gameSession.save();
    res.json(newPlayer);

}

const startGameSession = async (req, res) => {
    const sessionId = req.params.id;
    const gameSession = await gameSessionModel.findById(sessionId);
    gameSession.state = "started";
    gameSession.updatedAt = new Date();
    await gameSession.save();
    const io = req.io;
    io.emit("gameSessionStarted", gameSession); // TODO avisar solo a los de la partida
    
    startTimer(io);
    res.json(gameSession);
}
const startTimer = (io,timer = 30)=>{
    const interval = setInterval(() => {
        timer--;
        console.log("timer", timer);
        if(timer === 0){
            clearInterval(interval);
        }
        io.emit("timer", timer);
    }, 1000);
}
const nextQuestion = async (req, res) => {
    const sessionId = req.params.id;
    const gameSession = await gameSessionModel.findById(sessionId).populate("triviaId");
    gameSession.questionIndex++;
    if (gameSession.questionIndex >= gameSession.triviaId.questions.length) {
        gameSession.state = "finished";
        gameSession.questionIndex = 0;
        const io = req.io;
        io.emit("gameSessionFinished", gameSession);
        res.json(null);
    }
    gameSession.updatedAt = new Date();
    await gameSession.save();
    const trivia = gameSession.triviaId;
    const question = trivia.questions[gameSession.questionIndex];
    const io = req.io;
    io.emit("nextQuestion", question);
    startTimer(io,question.timer || 30);
    res.json(question);
}

const getQuestion = async (req, res) => {
    const sessionId = req.params.id;
    const gameSession = await gameSessionModel.findById(sessionId);
    const questionIndex = gameSession.questionIndex;
    const trivia = await triviaModel.findById(gameSession.triviaId);
    console.log("trivia", trivia);
    const question = trivia.questions[questionIndex];
    console.log("question", question);
    res.json(question);
}
const getQuestionPlayersStats = async (req, res) => {
    const sessionId = req.params.id;
    const gameSession = await gameSessionModel.findById(sessionId).populate("players").populate("triviaId");
    const questionIndex = gameSession.questionIndex;
    const question = gameSession.triviaId.questions[questionIndex];
    const playerStats = gameSession.players.map(player => {
        const answer = player.answers.find(answer => answer.questionId.toString() === question._id.toString());
        return {
            name: player.name,
            answerId: answer?.answerId,
            correct: answer?.isCorrect,
            createdAt: answer?.createdAt,
            delay: answer?.delay
        }
    })
    // preparar los stats para poder graficar con chartjs
    const correct = playerStats.filter(player => player.correct).length;
    const incorrect = playerStats.filter(player => !player.correct).length;
    const total = playerStats.length;
    const correctPercentage = (correct / total) * 100;
    const io  = req.io;
    io.emit("questionStats", {stats:playerStats,correct,incorrect,total,correctPercentage});
    res.json({stats:playerStats,correct,incorrect,total,correctPercentage});
}

const getSessionPlayerStats = async (req, res) => {
    const sessionId = req.params.id;
    const gameSession = await gameSessionModel.findById(sessionId).populate("players").populate("triviaId");
    const totalQuestions = gameSession.triviaId.questions.length;
    const players = gameSession.players.map(player => {
        const correct = player.answers.filter(answer => answer.isCorrect).length;
        const incorrect = player.answers.filter(answer => !answer.isCorrect).length;
        const total = player.answers.length;
        const correctPercentage = (correct / total) * 100;
        return {
            name: player.name,
            correct,
            incorrect,
            total,
            correctPercentage
        }
    })
    const correct = players.reduce((total, player) => total + player.correct, 0);
    const incorrect = players.reduce((total, player) => total + player.incorrect, 0);
    const total = players.reduce((total, player) => total + player.total, 0);
    const correctPercentage = (correct / total) * 100;
    res.json({players,totalQuestions,correct,incorrect,total,correctPercentage});
}
const answerQuestion = async (req, res) => {
    const { username, answerId, questionId } = req.body;
    const gameSessionId = req.params.id;
    const gameSession = await gameSessionModel.findById(gameSessionId).populate("players").populate("triviaId");
    const trivia = gameSession.triviaId;
    const isCorrect = trivia.questions[gameSession.questionIndex].answers.find(answer => answer._id.toString() === answerId.toString()).isCorrect;
    const player = gameSession.players.find(player => {
        console.log("player", player.name, username);
        return player.name == username
    });
    console.log("username", username, gameSession.players, player);
    if (!player) {
        return res.status(400).json({ error: "player not found" });
    }
    if (player.answers.some(answer => answer.questionId.toString() === questionId.toString())) {
        return res.status(400).json({ error: "question already answered" });
    }
    const delay = new Date().getTime() - gameSession.updatedAt.getTime();
    player.answers.push({ questionId, answerId, isCorrect,createdAt: new Date(), delay });
    await player.save();
    res.json(player);

}

const saveSocketIdToPlayer = async(username,sessionId,socketId) => {
    const player = await playerModel.findOne({name:username,gameSessionId:sessionId});
    if(!player){
        return;
    }
    player.socketId = socketId;
    await player.save();
}

export default {
    getGameSession,
    createGameSession,
    joinPlayer,
    startGameSession,
    nextQuestion,
    getQuestion,
    answerQuestion,
    getQuestionPlayersStats,
    getSessionPlayerStats,
    saveSocketIdToPlayer

}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-gameSessionController.html">gameSessionController</a></li></ul><h3>Classes</h3><ul><li><a href="ProductNameNotProvided.html">ProductNameNotProvided</a></li><li><a href="UserNameNotProvided.html">UserNameNotProvided</a></li></ul><h3>Global</h3><ul><li><a href="global.html#createTrivia">createTrivia</a></li><li><a href="global.html#isLoggedInAPI">isLoggedInAPI</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Wed May 21 2025 09:58:46 GMT+0200 (Central European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
